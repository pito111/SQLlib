<h1>SQL expansion</h1>
<p>The command <tt>sqlexpand</tt> can be used to expand environment variables within an SQL query in a safe way (i.e. handling embedded quotes).</p>
<p>The library <tt>sqlexpand.o</tt> can be used in other tools to achieve the same objective.</p>
<p>Note that some options are enabled / disabled by flags on the <tt>sqlexpand</tt> command, see <tt>--help</tt> for details.</p>
<h2>Simple expansion</h2>
<p>The simplest expansion is just <tt>$</tt> followed by a variable name (starts as a letter, or underscore, then letters, underscore or number).</p>
<p>However, if the next thing is a latter or number you can include the name in curly braces, e.g <tt>${<i>variable</i>}</tt>.</p>
<h2>Prefix</h2>
<p>Immediately before the variable name (and inside <tt>{...}</tt> if present) can be a number of prefixes.</p>
<table>
	<tr><td><tt>?</tt></td><td>Used in some special cases, such as testing if a variable exists.</td></tr>
	<tr><td><tt>@</tt></td><td>Consider the expanded value as a filename and read the value from that file.</td></tr>
	<tr><td><tt>-</tt></td><td>Replace all <tt>'</tt>, <tt>"</tt> or <tt>`</tt> with <tt>_</tt> (underscore).</td></tr>
	<tr><td><tt>,</tt></td><td>Ensures quotes around the expansion. Changes tab or comma to quote,comma,quote to make a clean list.</td></tr>
	<tr><td><tt>+</tt></td><td>URL encode the value. e.g. for <tt>?name=$+value</tt>. Use <tt>++</tt> to double escape. Note encodes space a <tt>%20</tt> not <tt>+</tt> so can be used in path. Does not escape <tt>/</tt>.</td></tr>
	<tr><td><tt>#</tt></td><td>Made MD5 of value, use <tt>##</tt> for SHA1. Value is hex (lower case).</td></tr>
	<tr><td><tt>=</tt></td><td>Base64 encode the value. If used with <tt>#</tt> or <tt>##</tt> then this is base64 of the binary hash instead of hex.</td></tr>
	<tr><td><tt>%</tt></td><td>Trust this variable <b>(use with care)</b> so allowing expansion outside quotes as is with no escaping.</td></tr>
</table>
<p>Only use <tt>$%<i>variable</i></tt> with great care, and ensure any construction of the variable value uses <tt>sqlexpand</tt> to safely escape what is being set.</p>
<h2>Special variable</h2>
<p>Instead of the variable name itself there are some special variables.</p>
<table>
	<tr><td><tt>$<i>variable</i></tt></td><td>If the variable name itself starts with a <tt>$</tt> then the variable contains a variable name. E.g. If variable <tt>X</tt> contains <tt>A</tt> then <tt>${$X}</tt> is the same as <tt>$A</tt>.</td></tr>
	<tr><td><tt>$</tt></td><td>Generate the parent PID (deprecated)</td></tr>
	<tr><td><tt>&lt;</tt></td><td>Read stdin</td></tr>
	<tr><td><tt>\</tt></td><td>Generate a back tick (so starts/ends back tick quoting if used outside other quotes).</td></tr>
	<tr><td><tt>/</tt></td><td>Generate a single quote (so starts/ends single quoting if used outside other quotes).</td></tr>
</table>
<h2>Index</h2>
<p>Immediately after the variable name (and inside <tt>{...}</tt> if present) can be an index of the form <tt>[<i>number</i>]</tt>. If present then the number is used as a n index in to the value. The value is split on tab characters and index <tt>[1]</tt> if the first part. This is done before considering any suffix.</p>
<h2>Suffix</h2>
<p>Immediately after the variable name (and inside <tt>{...}</tt>, and after <tt>[...]</tt>, if present) can be a number of suffixes.</p>
<table>
	<tr><td><tt>:h</tt></td><td>Head of path, removes all after last slash.</tt></td></tr>
	<tr><td><tt>:t</tt></td><td>Tail of path, only from after last slash (unchanged if no slash).</td></tr>
	<tr><td><tt>:e</tt></td><td>Extension. Everything after final dot if after last slash. Blank if no dot after last slash.</td></tr>
	<tr><td><tt>:r</tt></td><td>Remove extension. Removes last dot and anything after if it, if dot is after a slash.</td></tr>
</table>
<h2>Checking</h2>
<p>The final SQL has to then pass some tests to help catch any remaining possible SQL injection (e.g. from <tt>$%<i>variable</i></tt>).</p>
<ul>
	<li>Must have correctly balanced quotes (<tt>'</tt>, <tt>"</tt> and <tt>`</tt>).</li>
	<li>Must not contain an unquoted <tt>;</tt>, i.e. an attempt to make multiple commands.</li>
	<li>Must not contain an unquoted <tt>#</tt>, <tt>/*</tt> or <tt>--&nbsp;</tt>, i.e. an attempt to include a comment.</li>
</ul>
